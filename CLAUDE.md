# CLAUDE.md - Flight + Ralph Integration

## Overview

This project uses **Flight** for prompt engineering quality and **Ralph** (`/ralph-loop`) for autonomous execution.

- **Flight**: TDD-style methodology ensuring Claude generates correct code via domains, invariants, and constraints
- **Ralph**: Official Claude Code plugin for autonomous loop execution until completion

## Build Commands

### Embedded C (P10-compliant)
```bash
# Compile with strict P10 warnings
gcc -Wall -Wextra -Werror -pedantic -std=c11 -o output src/*.c

# Run tests
cd src && ./test_ring_buffer

# Static analysis (if available)
cppcheck --enable=all --error-exitcode=1 src/
```

## Available Domains

| Domain | Purpose |
|--------|---------|
| `embedded-c-p10.md` | NASA JPL Power of 10 safety-critical C rules |
| `rp2040-pico.md` | RP2040 Pico dual-core, spinlocks, ring buffers |
| `javascript.md` | JavaScript/Node.js patterns |
| `react.md` | React component patterns |
| `react-line-formulas.md` | React component line count estimation |
| `sms-twilio.md` | Twilio SMS integration |

## Before ANY Code Generation

1. **Read `.flight/domains/*.md`** - Load all domain constraints
2. **Check `@fix_plan.md`** - Current task priorities (if exists)
3. **Read `specs/`** - Technical specifications (if exists)
4. **Follow invariants** - If code follows the invariants, it's correct

## Flight Workflow (Quality)

### Slash Commands

| Command | Purpose |
|---------|---------|
| `/flight-prime` | Research context, scan codebase, identify constraints |
| `/flight-compile` | Build atomic prompt from task + domains → outputs to PROMPT.md |
| `/flight-validate` | Check output against domain invariants |
| `/flight-tighten` | Analyze failures, strengthen domain rules |

### Key Principle

**Invariants over guidelines.** Domain files contain MUST/NEVER rules. Code that follows them is correct.

## Ralph Workflow (Execution)

### The `/ralph-loop` Command

Ralph is a Claude Code plugin that creates an autonomous loop:
1. You give Claude a task
2. Claude works on it
3. When Claude tries to exit, a Stop hook blocks it
4. The same prompt is fed back with the updated codebase
5. Repeat until completion promise is found or max iterations reached

### Basic Usage

```bash
# Simple loop with completion detection
/ralph-loop "Build the user service" --completion-promise "COMPLETE"

# With iteration limit (recommended)
/ralph-loop "Implement auth flow" --max-iterations 20 --completion-promise "COMPLETE"
```

### With Flight-Generated Prompts

```bash
# Use PROMPT.md content directly
/ralph-loop "$(cat PROMPT.md)" --max-iterations 20 --completion-promise "COMPLETE"
```

### Key Options

| Option | Purpose |
|--------|---------|
| `--completion-promise "X"` | Stop when Claude outputs this exact string |
| `--max-iterations N` | Hard limit on loop iterations (safety) |

## Integrated Workflow

```
┌─────────────────────────────────────────────────────────┐
│  1. PRIME: Research & gather constraints                │
│     /flight-prime "Build user authentication system"    │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│  2. COMPILE: Generate atomic prompt with invariants     │
│     /flight-compile                                     │
│     Output → PROMPT.md                                  │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│  3. EXECUTE: Ralph loop until complete                  │
│     /ralph-loop "$(cat PROMPT.md)" --max-iterations 20  │
│       --completion-promise "COMPLETE"                   │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│  4. VALIDATE: Check against invariants                  │
│     /flight-validate                                    │
└────────────────────────┬────────────────────────────────┘
                         ▼
          ┌──────────────┴──────────────┐
          │ Pass?                       │
          ▼                             ▼
      ┌───────┐                   ┌───────────┐
      │ Done  │                   │ TIGHTEN   │
      └───────┘                   │ /flight-  │
                                  │ tighten   │
                                  └─────┬─────┘
                                        │
                                        ▼
                                  Update domain
                                  files, retry
```

## Project Structure

```
project/
├── CLAUDE.md              # This file
├── PROMPT.md              # Generated by /flight-compile, used with /ralph-loop
├── README.md              # Flight methodology overview
├── .flight/
│   ├── FLIGHT.md          # Core methodology reference
│   ├── domains/           # Constraint files (*.md) - see Available Domains above
│   ├── templates/         # Prompt skeletons
│   ├── examples/          # Reference implementations
│   └── exercises/         # Training exercises
├── .claude/
│   └── commands/          # Slash command definitions
│       ├── flight-prime.md
│       ├── flight-compile.md
│       ├── flight-validate.md
│       ├── flight-tighten.md
│       └── flight-check.md
├── specs/                 # Technical specifications
└── src/                   # Source code (C files, headers, tests)
```

## Domain File Format

Domain files define invariants - rules that MUST be followed:

```markdown
# Domain: [Name]

## Invariants

### MUST
- [Required behavior]
- [Required pattern]

### NEVER
- [Forbidden pattern]
- [Anti-pattern to avoid]

## Patterns

[Example code patterns that satisfy invariants]

## Error Codes

[Domain-specific error handling]
```

## Exit Conditions

Ralph loop stops when:
- Claude outputs the `--completion-promise` string (e.g., "COMPLETE")
- `--max-iterations` limit reached
- User cancels with `/cancel-ralph`

**Always use `--max-iterations`** to prevent runaway loops on impossible tasks.

## Quick Reference

```bash
# Start new feature
/flight-prime "Build [feature description]"
/flight-compile

# Execute with Ralph loop
/ralph-loop "$(cat PROMPT.md)" --max-iterations 20 --completion-promise "COMPLETE"

# After Ralph completes
/flight-validate

# If validation fails
/flight-tighten
# Then retry from /flight-compile
```

## Tips for Ralph Loop Success

1. **Always set `--max-iterations`** - Prevents infinite loops
2. **Write clear completion criteria** - So Claude knows when to output "COMPLETE"
3. **Keep tasks atomic** - One clear objective per loop
4. **Include what to do if stuck** in your prompts:
   ```
   If after 15 iterations this is not complete:
   - Document what's blocking progress
   - List what was attempted
   - Output: BLOCKED
   ```
